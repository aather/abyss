/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","app/app","lodash","jquery","jquery.flot"],function(a,b,c,d){"use strict";var e=a.module("grafana.panels.singlestat",[]);b.useModule(e),e.directive("singlestatPanel",["$location","linkSrv","$timeout","templateSrv",function(a,b,e,f){return{link:function(g,h){function i(){try{var a=g.height||q.height||g.row.height;return c.isString(a)&&(a=parseInt(a.replace("px",""),10)),a-=5,a-=q.title?24:9,h.css("height",a+"px"),!0}catch(b){return!1}}function j(a,b){if(!q.colorValue)return b;var c=k(a);return c?'<span style="color:'+c+'">'+b+"</span>":b}function k(a){for(var b=p.thresholds.length-1;b>=0;b--)if(a>=p.thresholds[b])return p.colorMap[b];return null}function l(a,b,c){return c=f.replace(c),'<span class="'+a+'" style="font-size:'+b+'">'+c+"</span>"}function m(){var a='<div class="singlestat-panel-value-container">';q.prefix&&(a+=l("singlestat-panel-prefix",q.prefixFontSize,g.panel.prefix));var b=j(p.valueRounded,p.valueFormated);return a+=l("singlestat-panel-value",q.valueFontSize,b),q.postfix&&(a+=l("singlestat-panel-postfix",q.postfixFontSize,q.postfix)),a+="</div>"}function n(){var a=g.panel,b=h.width()+20,c=h.height()||100,e=d("<div></div>"),f={};f.position="absolute",a.sparkline.full?(f.bottom="5px",f.left="-5px",f.width=b-10+"px",f.height=c-45+"px"):(f.bottom="0px",f.left="-5px",f.width=b-10+"px",f.height=Math.floor(.25*c)+"px"),e.css(f);var i={legend:{show:!1},series:{lines:{show:!0,fill:1,lineWidth:1,fillColor:a.sparkline.fillColor}},yaxes:{show:!1},xaxis:{show:!1,mode:"time",min:g.range.from.valueOf(),max:g.range.to.valueOf()},grid:{hoverable:!1,show:!1}};h.append(e);var j={data:p.flotpairs,color:a.sparkline.lineColor};d.plot(e,[j],i)}function o(){if(g.data){p=g.data,q=g.panel,i();var a=m();if(q.colorBackground&&!isNaN(p.valueRounded)){var c=k(p.valueRounded);c&&(s.css("background-color",c),g.fullscreen?h.css("background-color",c):h.css("background-color",""))}else s.css("background-color",""),h.css("background-color","");h.html(a),q.sparkline.show&&n(),h.toggleClass("pointer",q.links.length>0),r=q.links.length>0?b.getPanelLinkAnchorInfo(q.links[0],g.panel.scopedVars):null}}var p,q,r,s=h.parents(".panel-container");g.$on("render",function(){o(),g.panelRenderingComplete()});var t=d('<div id="tooltip" class="">hello</div>"');h.mouseleave(function(){0!==q.links.length&&t.detach()}),h.click(function(){if(r){if("_blank"===r.target){var b=window.open(r.href,"_blank");return void b.location}0===r.href.indexOf("http")?window.location.href=r.href:e(function(){a.url(r.href)}),t.detach()}}),h.mousemove(function(a){r&&(t.text("click to go to: "+r.title),t.place_tt(a.pageX+20,a.pageY-15))})}}}])});