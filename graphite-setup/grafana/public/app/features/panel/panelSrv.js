/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","config"],function(a,b,c){"use strict";var d=a.module("grafana.services");d.service("panelSrv",["$rootScope","$timeout","datasourceSrv","$q",function(a,d,e,f){this.init=function(g){g.panel.span||(g.panel.span=12),g.inspector={},g.editPanel=function(){g.toggleFullscreen(!0)},g.sharePanel=function(){g.appEvent("show-modal",{src:"./app/features/dashboard/partials/shareModal.html",scope:g.$new()})},g.editPanelJson=function(){g.appEvent("show-json-editor",{object:g.panel,updateHandler:g.replacePanel})},g.duplicatePanel=function(){g.dashboard.duplicatePanel(g.panel,g.row)},g.updateColumnSpan=function(a){g.updatePanelSpan(g.panel,a),d(function(){g.$broadcast("render")})},g.addDataQuery=function(a){g.dashboard.addDataQueryTo(g.panel,a)},g.removeDataQuery=function(a){g.dashboard.removeDataQuery(g.panel,a),g.get_data()},g.duplicateDataQuery=function(a){g.dashboard.duplicateDataQuery(g.panel,a)},g.moveDataQuery=function(a,b){g.dashboard.moveDataQuery(g.panel,a,b)},g.setDatasource=function(a){a.meta.mixed?b.each(g.panel.targets,function(a){a.datasource=g.panel.datasource,null===a.datasource&&(a.datasource=c.defaultDatasource)}):g.datasource&&g.datasource.meta.mixed&&b.each(g.panel.targets,function(a){delete a.datasource}),g.panel.datasource=a.value,g.datasource=null,g.get_data()},g.toggleEditorHelp=function(a){return g.editorHelpIndex===a?void(g.editorHelpIndex=null):void(g.editorHelpIndex=a)},g.isNewPanel=function(){return g.panel.title===c.new_panel_title},g.toggleFullscreen=function(a){g.dashboardViewState.update({fullscreen:!0,edit:a,panelId:g.panel.id})},g.otherPanelInFullscreenMode=function(){return g.dashboardViewState.fullscreen&&!g.fullscreen},g.getCurrentDatasource=function(){return g.datasource?f.when(g.datasource):e.get(g.panel.datasource)},g.panelRenderingComplete=function(){a.performance.panelsRendered++},g.get_data=function(){if(!g.otherPanelInFullscreenMode()){if(g.panel.snapshotData)return void(g.loadSnapshot&&g.loadSnapshot(g.panel.snapshotData));delete g.panelMeta.error,g.panelMeta.loading=!0,g.getCurrentDatasource().then(function(a){return g.datasource=a,g.refreshData(g.datasource)||f.when({})}).then(function(){g.panelMeta.loading=!1},function(a){console.log("Panel data error:",a),g.panelMeta.loading=!1,g.panelMeta.error=a.message||"Timeseries data request error",g.inspector.error=a})}},g.refreshData&&g.$on("refresh",g.get_data),g.fullscreen=!1,g.editor={index:1},g.dashboardViewState.registerPanel(g),g.datasources=e.getMetricSources(),g.skipDataOnInit||d(function(){g.get_data()},30)}}])});