/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","app/core/utils/datemath","app/core/utils/rangeutil","lodash","kbn","jquery"],function(a,b,c,d,e,f){"use strict";var g=a.module("grafana.services");g.service("panelHelper",["timeSrv","$rootScope",function(a,g){var h=this;this.setTimeQueryStart=function(a){a.timing={},a.timing.queryStart=(new Date).getTime()},this.setTimeQueryEnd=function(a){a.timing.queryEnd=(new Date).getTime()},this.setTimeRenderStart=function(a){a.timing=a.timing||{},a.timing.renderStart=(new Date).getTime()},this.setTimeRenderEnd=function(a){a.timing.renderEnd=(new Date).getTime()},this.broadcastRender=function(a,b){this.setTimeRenderStart(a),a.$broadcast("render",b),this.setTimeRenderEnd(a),g.profilingEnabled&&g.performance.panels.push({panelId:a.panel.id,query:a.timing.queryEnd-a.timing.queryStart,render:a.timing.renderEnd-a.timing.renderStart})},this.updateTimeRange=function(b){b.range=a.timeRange(),b.rangeRaw=a.timeRange(!1),this.applyPanelTimeOverrides(b),b.resolution=b.panel.maxDataPoints?b.panel.maxDataPoints:Math.ceil(f(window).width()*(b.panel.span/12)),b.interval=e.calculateInterval(b.range,b.resolution,b.panel.interval)},this.applyPanelTimeOverrides=function(a){if(a.panelMeta.timeInfo="",a.panel.timeFrom){var e=c.describeTextRange(a.panel.timeFrom);if(e.invalid)return void(a.panelMeta.timeFromInfo="invalid time override");if(d.isString(a.rangeRaw.from)){var f=b.parse(e.from);a.panelMeta.timeInfo=e.display,a.rangeRaw.from=e.from,a.rangeRaw.to=e.to,a.range.from=f}}if(a.panel.timeShift){var g=c.describeTextRange(a.panel.timeShift);if(g.invalid)return void(a.panelMeta.timeInfo="invalid timeshift");var h="-"+a.panel.timeShift;a.panelMeta.timeInfo+=" timeshift "+h,a.range.from=b.parseDateMath(h,a.range.from,!1),a.range.to=b.parseDateMath(h,a.range.to,!0),a.rangeRaw=a.range}a.panel.hideTimeOverride&&(a.panelMeta.timeInfo="")},this.issueMetricQuery=function(a,b){var c={range:a.range,rangeRaw:a.rangeRaw,interval:a.interval,targets:a.panel.targets,format:"png"===a.panel.renderer?"png":"json",maxDataPoints:a.resolution,scopedVars:a.panel.scopedVars,cacheTimeout:a.panel.cacheTimeout};return this.setTimeQueryStart(a),b.query(c).then(function(b){return h.setTimeQueryEnd(a),a.dashboard.snapshot&&(a.panel.snapshotData=b),b})}}])});