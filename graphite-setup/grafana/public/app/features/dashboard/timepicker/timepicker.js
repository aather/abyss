/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["require","exports","./input_date","angular","lodash","moment","app/core/utils/rangeutil"],function(a,b,c,d,e,f,g){function h(){"use strict";return{restrict:"E",templateUrl:"app/features/dashboard/timepicker/settings.html",controller:j,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}}function i(){"use strict";return{restrict:"E",templateUrl:"app/features/dashboard/timepicker/timepicker.html",controller:j,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}}var j=function(){function a(a,b,c){var d=this;this.$scope=a,this.$rootScope=b,this.timeSrv=c,a.ctrl=this,b.onAppEvent("zoom-out",function(){return d.zoom(2)},a),b.onAppEvent("refresh",function(){return d.init()},a),b.onAppEvent("dash-editor-hidden",function(){return d.isOpen=!1},a),this.init()}return a.$inject=["$scope","$rootScope","timeSrv"],a.prototype.init=function(){this.panel=this.dashboard.timepicker,e.defaults(this.panel,a.defaults);var b=d.copy(this.timeSrv.timeRange()),c=d.copy(this.timeSrv.timeRange(!1));"browser"===this.dashboard.timezone?(b.from.local(),b.to.local(),f.isMoment(c.from)&&c.from.local(),f.isMoment(c.to)&&c.to.local()):this.isUtc=!0,this.rangeString=g.describeTimeRange(c),this.absolute={fromJs:b.from.toDate(),toJs:b.to.toDate()},this.tooltip=this.dashboard.formatDate(b.from)+" <br>to<br>",this.tooltip+=this.dashboard.formatDate(b.to),this.isOpen||(this.timeRaw=c)},a.prototype.zoom=function(a){var b=this.timeSrv.timeRange(),c=b.to.valueOf()-b.from.valueOf(),d=b.to.valueOf()-c/2,e=d+c*a/2,g=d-c*a/2;if(e>Date.now()&&b.to<=Date.now()){var h=e-Date.now();g-=h,e=Date.now()}this.timeSrv.setTime({from:f.utc(g),to:f.utc(e)})},a.prototype.openDropdown=function(){this.init(),this.isOpen=!0,this.timeOptions=g.getRelativeTimesList(this.panel,this.rangeString),this.refresh={value:this.dashboard.refresh,options:e.map(this.panel.refresh_intervals,function(a){return{text:a,value:a}})},this.refresh.options.unshift({text:"off"}),this.$rootScope.appEvent("show-dash-editor",{src:"app/features/dashboard/timepicker/dropdown.html",scope:this.$scope,cssClass:"gf-timepicker-dropdown"})},a.prototype.applyCustom=function(){this.refresh.value!==this.dashboard.refresh&&this.timeSrv.setAutoRefresh(this.refresh.value),this.timeSrv.setTime(this.timeRaw),this.$rootScope.appEvent("hide-dash-editor")},a.prototype.absoluteFromChanged=function(){this.timeRaw.from=this.getAbsoluteMomentForTimezone(this.absolute.fromJs)},a.prototype.absoluteToChanged=function(){this.timeRaw.to=this.getAbsoluteMomentForTimezone(this.absolute.toJs)},a.prototype.getAbsoluteMomentForTimezone=function(a){return"browser"===this.dashboard.timezone?f(a):f(a).utc()},a.prototype.setRelativeFilter=function(a){this.panel.now=!0;var b={from:a.from,to:a.to};this.panel.nowDelay&&"now"===b.to&&(b.to="now-"+this.panel.nowDelay),this.timeSrv.setTime(b),this.$rootScope.appEvent("hide-dash-editor")},a.tooltipFormat="MMM D, YYYY HH:mm:ss",a.defaults={time_options:["5m","15m","1h","6h","12h","24h","2d","7d","30d"],refresh_intervals:["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"]},a}();b.TimePickerCtrl=j,b.settingsDirective=h,b.timePickerDirective=i,d.module("grafana.directives").directive("gfTimePickerSettings",h),d.module("grafana.directives").directive("gfTimePicker",i)});