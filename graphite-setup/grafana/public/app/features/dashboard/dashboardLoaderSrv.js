/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","moment","lodash","jquery","kbn","app/core/utils/datemath"],function(a,b,c,d,e,f){"use strict";var g=a.module("grafana.services");g.service("dashboardLoaderSrv",["backendSrv","dashboardSrv","datasourceSrv","$http","$q","$timeout","contextSrv","$routeParams","$rootScope",function(a,g,h,i,j,k,l,m,n){var o=this;this._dashboardLoadFailed=function(a){return{meta:{canStar:!1,canDelete:!1,canSave:!1},dashboard:{title:a}}},this.loadDashboard=function(b,c){return"script"===b?this._loadScriptedDashboard(c):"snapshot"===b?a.get("/api/snapshots/"+m.slug)["catch"](function(){return{meta:{isSnapshot:!0,canSave:!1,canEdit:!1},dashboard:{title:"Snapshot not found"}}}):a.getDashboard(m.type,m.slug)["catch"](function(){return o._dashboardLoadFailed("Not found")})},this._loadScriptedDashboard=function(a){var b="public/dashboards/"+a.replace(/\.(?!js)/,"/")+"?"+(new Date).getTime();return i({url:b,method:"GET"}).then(this._executeScript).then(function(a){return{meta:{fromScript:!0,canDelete:!1,canSave:!1,canStar:!1},dashboard:a.data}},function(a){return console.log("Script dashboard error "+a),n.appEvent("alert-error",["Script Error","Please make sure it exists and returns a valid dashboard"]),o._dashboardLoadFailed("Scripted dashboard")})},this._executeScript=function(a){var i={dashboardSrv:g,datasourceSrv:h,$q:j},l=new Function("ARGS","kbn","dateMath","_","moment","window","document","$","jQuery","services",a.data),n=l(m,e,f,c,b,window,document,d,d,i);if(c.isFunction(n)){var o=j.defer();return n(function(a){k(function(){o.resolve({data:a})})}),o.promise}return{data:n}}}])});