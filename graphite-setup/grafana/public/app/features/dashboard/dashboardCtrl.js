/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","jquery","config","lodash"],function(a,b,c){"use strict";var d=a.module("grafana.controllers");d.controller("DashboardCtrl",["$scope","$rootScope","dashboardKeybindings","timeSrv","templateValuesSrv","dynamicDashboardSrv","dashboardSrv","unsavedChangesSrv","dashboardViewStateSrv","contextSrv","$timeout",function(b,d,e,f,g,h,i,j,k,l,m){b.editor={index:0},b.topNavPartial="app/features/dashboard/partials/dashboardTopNav.html",b.panels=c.panels;var n;this.init=function(a){b.resetRow(),b.registerWindowResizeEvent(),b.onAppEvent("show-json-editor",b.showJsonEditor),b.setupDashboard(a)},b.setupDashboard=function(a){d.performance.dashboardLoadStart=(new Date).getTime(),d.performance.panelsInitialized=0,d.performance.panelsRendered=0;var c=i.create(a.dashboard,a.meta);i.setCurrent(c),f.init(c),g.init(c)["finally"](function(){h.init(c),j.init(c,b),b.dashboard=c,b.dashboardMeta=c.meta,b.dashboardViewState=k.create(b),e.shortcuts(b),b.updateTopNavPartial(),b.updateSubmenuVisibility(),b.setWindowTitleAndTheme(),b.appEvent("dashboard-loaded",b.dashboard)})["catch"](function(a){a.data&&a.data.message&&(a.message=a.data.message),b.appEvent("alert-error",["Dashboard init failed","Template variables could not be initialized: "+a.message])})},b.updateTopNavPartial=function(){b.dashboard.meta.isSnapshot&&(b.topNavPartial="app/features/dashboard/partials/snapshotTopNav.html")},b.updateSubmenuVisibility=function(){b.submenuEnabled=b.dashboard.isSubmenuFeaturesEnabled()},b.setWindowTitleAndTheme=function(){window.document.title=c.window_title_prefix+b.dashboard.title},b.broadcastRefresh=function(){d.performance.panelsRendered=0,d.$broadcast("refresh")},b.addRow=function(a,b){a.rows.push(b)},b.addRowDefault=function(){b.resetRow(),b.row.title="New row",b.addRow(b.dashboard,b.row)},b.resetRow=function(){b.row={title:"",height:"250px",editable:!0}},b.panelEditorPath=function(a){return"app/"+c.panels[a].path+"/editor.html"},b.pulldownEditorPath=function(a){return"app/panels/"+a+"/editor.html"},b.showJsonEditor=function(a,c){var e=d.$new();e.object=c.object,e.updateHandler=c.updateHandler,b.appEvent("show-dash-editor",{src:"app/partials/edit_json.html",scope:e})},b.onDrop=function(a,c,e){var f=b.dashboard.getPanelInfoById(a);if(e){var g=b.dashboard.getPanelInfoById(e.id);g.row.panels[g.index]=f.panel,f.row.panels[f.index]=e;var h=f.panel.span;f.panel.span=e.span,e.span=h}else f.row.panels.splice(f.index,1),f.panel.span=12-b.dashboard.rowSpan(c),c.panels.push(f.panel);d.$broadcast("render")},b.registerWindowResizeEvent=function(){a.element(window).bind("resize",function(){m.cancel(n),n=m(function(){b.$broadcast("render")},200)}),b.$on("$destroy",function(){a.element(window).unbind("resize")})}}])});