/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash"],function(a,b){"use strict";var c=a.module("grafana.services");c.service("dynamicDashboardSrv",function(){var c=this;this.init=function(a){a.snapshot||(this.iteration=(new Date).getTime(),this.process(a))},this.update=function(a){a.snapshot||(this.iteration=this.iteration+1,this.process(a))},this.process=function(a){if(0!==a.templating.list.length){this.dashboard=a;var c,d,e,f;for(c=0;c<this.dashboard.rows.length;c++)for(e=this.dashboard.rows[c],e.repeat?this.repeatRow(e):e.repeatRowId&&e.repeatIteration!==this.iteration&&(this.dashboard.rows.splice(c,1),c-=1),d=0;d<e.panels.length;d++)f=e.panels[d],f.repeat?this.repeatPanel(f,e):f.repeatPanelId&&f.repeatIteration!==this.iteration&&(e.panels=b.without(e.panels,f),d-=1)}},this.getRowClone=function(c,d){if(0===d)return c;var e,f,g,h,i=b.indexOf(this.dashboard.rows,c)+1;for(e=0;e<this.dashboard.rows.length;e++)if(g=this.dashboard.rows[e],g.repeatRowId===i&&g.repeatIteration!==this.iteration){h=g;break}if(!h)for(h=a.copy(c),this.dashboard.rows.push(h),e=0;e<h.panels.length;e++)f=h.panels[e],f.id=this.dashboard.getNextPanelId();return h.repeat=null,h.repeatRowId=i,h.repeatIteration=this.iteration,h},this.repeatRow=function(a){var d=this.dashboard.templating.list,e=b.findWhere(d,{name:a.repeat});if(e){var f,g,h,i;f="All"===e.current.text?e.options.slice(1,e.options.length):b.filter(e.options,{selected:!0}),b.each(f,function(b,d){for(g=c.getRowClone(a,d),g.scopedVars={},g.scopedVars[e.name]=b,h=0;h<g.panels.length;h++)i=g.panels[h],i.scopedVars={},i.scopedVars[e.name]=b})}},this.getPanelClone=function(b,c,d){if(0===d)return b;var e,f,g,h;for(e=0;e<c.panels.length;e++)if(g=c.panels[e],g.repeatIteration!==this.iteration&&g.repeatPanelId===b.id){h=g;break}return h||(h={id:this.dashboard.getNextPanelId()},c.panels.push(h)),f=h.id,a.copy(b,h),h.id=f,h.repeatIteration=this.iteration,h.repeatPanelId=b.id,h.repeat=null,h},this.repeatPanel=function(a,d){var e=this.dashboard.templating.list,f=b.findWhere(e,{name:a.repeat});if(f){var g;g="All"===f.current.text?f.options.slice(1,f.options.length):b.filter(f.options,{selected:!0}),b.each(g,function(b,e){var h=c.getPanelClone(a,d,e);h.span=Math.max(12/g.length,a.minSpan),h.scopedVars=h.scopedVars||{},h.scopedVars[f.name]=b})}}})});