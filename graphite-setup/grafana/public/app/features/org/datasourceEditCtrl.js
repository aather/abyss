/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","config","lodash"],function(a,b,c){"use strict";var d=a.module("grafana.controllers"),e=[];d.controller("DataSourceEditCtrl",["$scope","$q","backendSrv","$routeParams","$location","datasourceSrv",function(d,f,g,h,i,j){d.httpConfigPartialSrc="app/features/org/partials/datasourceHttpConfig.html";var k={name:"",type:"graphite",url:"",access:"proxy"};d.indexPatternTypes=[{name:"No pattern",value:void 0},{name:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{name:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{name:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{name:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{name:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],d.init=function(){d.isNew=!0,d.datasources=[],d.loadDatasourceTypes().then(function(){h.id?d.getDatasourceById(h.id):(d.current=a.copy(k),d.typeChanged())})},d.loadDatasourceTypes=function(){return e.length>0?(d.types=e,f.when(null)):g.get("/api/datasources/plugins").then(function(a){e=a,d.types=a})},d.getDatasourceById=function(a){g.get("/api/datasources/"+a).then(function(a){d.isNew=!1,d.current=a,d.typeChanged()})},d.typeChanged=function(){d.datasourceMeta=d.types[d.current.type]},d.updateFrontendSettings=function(){return g.get("/api/frontend/settings").then(function(a){b.datasources=a.datasources,b.defaultDatasource=a.defaultDatasource,j.init()})},d.testDatasource=function(){d.testing={done:!1},j.get(d.current.name).then(function(a){return a.testDatasource?a.testDatasource().then(function(a){d.testing.message=a.message,d.testing.status=a.status,d.testing.title=a.title},function(a){a.statusText?(d.testing.message=a.statusText,d.testing.title="HTTP Error"):(d.testing.message=a.message,d.testing.title="Unknown error")}):(d.testing.message="Data source does not support test connection feature.",d.testing.status="warning",void(d.testing.title="Unknown"))})["finally"](function(){d.testing.done=!0})},d.saveChanges=function(a){return d.editForm.$valid?d.current.id?g.put("/api/datasources/"+d.current.id,d.current).then(function(){d.updateFrontendSettings().then(function(){a?d.testDatasource():i.path("datasources")})}):g.post("/api/datasources",d.current).then(function(a){d.updateFrontendSettings(),i.path("datasources/edit/"+a.id)}):void 0},d.indexPatternTypeChanged=function(){var a=c.findWhere(d.indexPatternTypes,{value:d.current.jsonData.interval});d.current.database=a.example||"es-index-name"},d.init()}])});