/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","./editorCtrl"],function(a,b){"use strict";var c=a.module("grafana.services");c.service("annotationsSrv",["datasourceSrv","$q","alertSrv","$rootScope",function(a,c,d,e){function f(a){console.log("Annotation error: ",a);var b=a.message||"Annotation query failed";d.set("Annotations error",b,"error")}var g,h=[],i=this;this.init=function(){e.onAppEvent("refresh",this.clearCache,e),e.onAppEvent("setup-dashboard",this.clearCache,e)},this.clearCache=function(){g=null,h=[]},this.getAnnotations=function(d,e){if(0===e.annotations.list.length)return c.when(null);if(g)return g;i.dashboard=e;var j=b.where(e.annotations.list,{enable:!0}),k=b.map(j,function(b){return a.get(b.datasource).then(function(a){return a.annotationQuery(b,d).then(i.receiveAnnotationResults).then(null,f)},this)});return g=c.all(k).then(function(){return h})},this.receiveAnnotationResults=function(a){for(var b=0;b<a.length;b++)i.addAnnotation(a[b])},this.addAnnotation=function(a){h.push({annotation:a.annotation,min:a.time,max:a.time,eventType:a.annotation.name,title:a.title,tags:a.tags,text:a.text,score:1})},this.init()}])});