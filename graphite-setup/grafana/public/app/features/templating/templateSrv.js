/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","./editorCtrl","./templateValuesSrv"],function(a,b){"use strict";var c=a.module("grafana.services");c.service("templateSrv",function(){var a=this;this._regex=/\$(\w+)|\[\[([\s\S]+?)\]\]/g,this._values={},this._texts={},this._grafanaVariables={},this.init=function(a){this.variables=a,this.updateTemplateData()},this.updateTemplateData=function(){this._values={},this._texts={},b.each(this.variables,function(a){a.current&&(a.current.isNone||a.current.value)&&(this._values[a.name]=this.renderVariableValue(a),this._texts[a.name]=a.current.text)},this)},this.renderVariableValue=function(a){var c=a.current.value;if(b.isString(c))return c;switch(a.multiFormat){case"regex values":return"("+c.join("|")+")";case"lucene":var d=b.map(c,function(a){return'\\"'+a+'\\"'});return"("+d.join(" OR ")+")";case"pipe":return c.join("|");default:return"{"+c.join(",")+"}"}},this.setGrafanaVariable=function(a,b){this._grafanaVariables[a]=b},this.variableExists=function(b){this._regex.lastIndex=0;var c=this._regex.exec(b);return c&&void 0!==a._values[c[1]||c[2]]},this.containsVariable=function(a,b){return a?-1!==a.indexOf("$"+b)||-1!==a.indexOf("[["+b+"]]"):!1},this.highlightVariablesAsHtml=function(c){return c&&b.isString(c)?(this._regex.lastIndex=0,c.replace(this._regex,function(b,c,d){return a._values[c||d]?'<span class="template-variable">'+b+"</span>":b})):c},this.replace=function(b,c){if(!b)return b;var d;return this._regex.lastIndex=0,b.replace(this._regex,function(b,e,f){return c&&(d=c[e||f])?d.value:(d=a._values[e||f],d?a._grafanaVariables[d]||d:b)})},this.replaceWithText=function(b,c){if(!b)return b;var d,e;return this._regex.lastIndex=0,b.replace(this._regex,function(b,f,g){if(c){var h=c[f||g];if(h)return h.text}return d=a._values[f||g],e=a._texts[f||g],d?a._grafanaVariables[d]||e:b})},this.fillVariableValuesForUrl=function(a,c){b.each(this.variables,function(b){var d=b.current,e=d.value;"All"===d.text&&(e="All"),c&&void 0!==c[b.name]&&(e=c[b.name].value),a["var-"+b.name]=e})}})});