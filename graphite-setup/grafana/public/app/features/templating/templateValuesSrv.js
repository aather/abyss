/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","kbn"],function(a,b,c){"use strict";var d=a.module("grafana.services");d.service("templateValuesSrv",["$q","$rootScope","datasourceSrv","$location","templateSrv","timeSrv",function(d,e,f,g,h,i){function j(){return{text:"None",value:"",isNone:!0}}var k=this;e.onAppEvent("time-range-changed",function(){var a=b.findWhere(k.variables,{type:"interval"});a&&k.updateAutoInterval(a)},e),this.init=function(a){this.variables=a.templating.list,h.init(this.variables);for(var b=g.search(),c=[],e=0;e<this.variables.length;e++){var f=this.variables[e],i=b["var-"+f.name];void 0!==i?c.push(this.setVariableFromUrl(f,i)):f.refresh?c.push(this.updateOptions(f)):"interval"===f.type&&this.updateAutoInterval(f)}return d.all(c)},this.setVariableFromUrl=function(a,c){if(a.refresh){var d=this;return this.updateOptions(a).then(function(){var e=b.findWhere(a.options,{text:c});return e=e||{text:c,value:c},d.updateAutoInterval(a),d.setVariableValue(a,e)})}var e=b.findWhere(a.options,{text:c});return e=e||{text:c,value:c},this.updateAutoInterval(a),this.setVariableValue(a,e)},this.updateAutoInterval=function(a){if(a.auto){a.options.length&&"auto"!==a.options[0].text&&a.options.unshift({text:"auto",value:"$__auto_interval"});var b=c.calculateInterval(i.timeRange(),a.auto_count);h.setGrafanaVariable("$__auto_interval",b)}},this.setVariableValue=function(c,d){return c.current=a.copy(d),b.isArray(c.current.value)&&(c.current.text=c.current.value.join(" + ")),k.selectOptionsForCurrentValue(c),h.updateTemplateData(),k.updateOptionsInChildVariables(c)},this.variableUpdated=function(a){return h.updateTemplateData(),this.updateOptionsInChildVariables(a)},this.updateOptionsInChildVariables=function(a){var c=b.map(k.variables,function(b){return b!==a&&h.containsVariable(b.query,a.name)?k.updateOptions(b):void 0});return d.all(c)},this._updateNonQueryVariable=function(a){a.options=b.map(a.query.split(/[,]+/),function(a){return{text:a.trim(),value:a.trim()}}),"interval"===a.type&&k.updateAutoInterval(a)},this.updateOptions=function(a){return"query"!==a.type?(k._updateNonQueryVariable(a),k.setVariableValue(a,a.options[0]),d.when([])):f.get(a.datasource).then(b.partial(this.updateOptionsFromMetricFindQuery,a)).then(b.partial(this.updateTags,a)).then(b.partial(this.validateVariableSelectionState,a))},this.selectOptionsForCurrentValue=function(a){var c,d,e,f;for(c=0;c<a.options.length;c++)if(f=a.options[c],f.selected=!1,b.isArray(a.current.value))for(d=0;d<a.current.value.length;d++)e=a.current.value[d],f.value===e&&(f.selected=!0);else f.value===a.current.value&&(f.selected=!0)},this.validateVariableSelectionState=function(a){if(!a.current){if(!a.options.length)return;return k.setVariableValue(a,a.options[0])}if(!b.isArray(a.current.value)){var c=b.findWhere(a.options,{text:a.current.text});if(c)return k.setVariableValue(a,c);if(!a.options.length)return;return k.setVariableValue(a,a.options[0])}k.selectOptionsForCurrentValue(a)},this.updateTags=function(a,b){return a.useTags?b.metricFindQuery(a.tagsQuery).then(function(c){a.tags=[];for(var d=0;d<c.length;d++)a.tags.push(c[d].text);return b}):(delete a.tags,b)},this.updateOptionsFromMetricFindQuery=function(a,b){return b.metricFindQuery(a.query).then(function(c){return a.options=k.metricNamesToVariableValues(a,c),a.includeAll&&k.addAllOption(a),a.options.length||a.options.push(j()),b})},this.getValuesForTag=function(a,c){return f.get(a.datasource).then(function(d){var e=a.tagValuesQuery.replace("$tag",c);return d.metricFindQuery(e).then(function(a){return b.map(a,function(a){return a.text})})})},this.metricNamesToVariableValues=function(a,d){var e,f,g,i;for(f={},a.regex&&(e=c.stringToJsRegex(h.replace(a.regex))),g=0;g<d.length;g++){var j=d[g].text;if(e){if(i=e.exec(j),!i)continue;i.length>1&&(j=i[1])}f[j]=j}return b.map(b.keys(f).sort(),function(b){var c={text:b,value:b};return k.shouldRegexEscape(a)&&(c.value=k.regexEscape(c.value)),c})},this.shouldRegexEscape=function(a){return(a.includeAll||a.multi)&&-1!==a.allFormat.indexOf("regex")},this.regexEscape=function(a){return a.replace(/[-[\]{}()*+!<=:?.\/\\^$|#\s,]/g,"\\$&")},this.addAllOption=function(a){var c="";switch(a.allFormat){case"wildcard":c="*";break;case"regex wildcard":c=".*";break;case"lucene":var d=b.map(a.options,function(a){return'\\"'+a.text+'\\"'});c="("+d.join(" OR ")+")";break;case"regex values":c="("+b.map(a.options,function(a){return k.regexEscape(a.text)}).join("|")+")";break;case"pipe":c=b.pluck(a.options,"text").join("|");break;default:c="{",c+=b.pluck(a.options,"text").join(","),c+="}"}a.options.unshift({text:"All",value:c})}}])});