/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["lodash","./query_def"],function(a,b){"use strict";function c(a,b){this.targets=a,this.response=b}return c.prototype.processMetrics=function(a,b,c,d){var e,f,g,h,i,j;for(f=0;f<b.metrics.length;f++)switch(e=b.metrics[f],e.type){case"count":for(h={datapoints:[],metric:"count",props:d},g=0;g<a.buckets.length;g++)i=a.buckets[g],j=i.doc_count,h.datapoints.push([j,i.key]);c.push(h);break;case"percentiles":if(0===a.buckets.length)break;var k=a.buckets[0],l=k[e.id].values;for(var m in l){for(h={datapoints:[],metric:"p"+m,props:d,field:e.field},g=0;g<a.buckets.length;g++){i=a.buckets[g];var n=i[e.id].values;h.datapoints.push([n[m],i.key])}c.push(h)}break;case"extended_stats":for(var o in e.meta)if(e.meta[o]){for(h={datapoints:[],metric:o,props:d,field:e.field},g=0;g<a.buckets.length;g++){i=a.buckets[g];var p=i[e.id];p.std_deviation_bounds_upper=p.std_deviation_bounds.upper,p.std_deviation_bounds_lower=p.std_deviation_bounds.lower,h.datapoints.push([p[o],i.key])}c.push(h)}break;default:for(h={datapoints:[],metric:e.type,field:e.field,props:d},g=0;g<a.buckets.length;g++)i=a.buckets[g],j=i[e.id].value,h.datapoints.push([j,i.key]);c.push(h)}},c.prototype.processBuckets=function(b,c,d,e){var f,g,h,i;for(i in b)if(g=a.findWhere(c.bucketAggs,{id:i}),h=b[i],g)if("date_histogram"===g.type)this.processMetrics(h,c,d,e);else for(var j in h.buckets)f=h.buckets[j],e=a.clone(e),f.key?e[g.field]=f.key:e.filter=j,this.processBuckets(f,c,d,e)},c.prototype._getMetricName=function(c){var d=a.findWhere(b.metricAggTypes,{value:c});return d||(d=a.findWhere(b.extendedStats,{value:c})),d?d.text:c},c.prototype._getSeriesName=function(b,c,d){var e=this._getMetricName(b.metric);if(c.alias){var f=/\{\{([\s\S]+?)\}\}/g;return c.alias.replace(f,function(a,c,d){var f=c||d;return 0===f.indexOf("term ")?b.props[f.substring(5)]:b.props[f]?b.props[f]:"metric"===f?e:"field"===f?b.field:a})}b.field&&(e+=" "+b.field);var g=a.keys(b.props);if(0===g.length)return e;var h="";for(var i in b.props)h+=b.props[i]+" ";return 1===d?h.trim():h.trim()+" "+e},c.prototype.nameSeries=function(b,c){for(var d=a.uniq(a.pluck(b,"metric")).length,e=a.uniq(a.pluck(b,"field")).length,f=0;f<b.length;f++){var g=b[f];g.target=this._getSeriesName(g,c,d,e)}},c.prototype.getTimeSeries=function(){for(var a=[],b=0;b<this.response.responses.length;b++){var c=this.response.responses[b];if(c.error)throw{message:c.error};var d=c.aggregations,e=this.targets[b],f=[];this.processBuckets(d,e,f,{}),this.nameSeries(f,e);for(var g=0;g<f.length;g++)a.push(f[g])}return{data:a}},c});