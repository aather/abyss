/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash"],function(a,b){"use strict";var c=a.module("grafana.controllers");c.controller("ElasticQueryCtrl",["$scope","$timeout","uiSegmentSrv","templateSrv",function(c,d,e,f){c.init=function(){var a=c.target;a&&(a.metrics=a.metrics||[{type:"count",id:"1"}],a.bucketAggs=a.bucketAggs||[{type:"date_histogram",id:"2",settings:{interval:"auto"}}],a.timeField=c.datasource.timeField)},c.getFields=function(b){var d=a.toJson({find:"fields",type:b});return c.datasource.metricFindQuery(d).then(c.transformToSegments(!1)).then(null,c.handleQueryError)},c.queryUpdated=function(){var b=a.toJson(c.datasource.queryBuilder.build(c.target),!0);b!==c.oldQueryRaw&&(c.rawQueryOld=b,c.get_data()),c.appEvent("elastic-query-updated")},c.transformToSegments=function(a){return function(c){var d=b.map(c,function(a){return e.newSegment({value:a.text,expandable:a.expandable})});return a&&b.each(f.variables,function(a){d.unshift(e.newSegment({type:"template",value:"$"+a.name,expandable:!0}))}),d}},c.handleQueryError=function(a){return c.parserError=a.message||"Failed to issue metric query",[]},c.toggleQueryMode=function(){c.target.rawQuery?delete c.target.rawQuery:c.target.rawQuery=a.toJson(c.datasource.queryBuilder.build(c.target),!0)},c.init()}])});