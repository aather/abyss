/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular"],function(a){"use strict";function b(a){this.timeField=a.timeField}return b.prototype.getRangeFilter=function(){var a={};return a[this.timeField]={gte:"$timeFrom",lte:"$timeTo"},a},b.prototype.buildTermsAgg=function(a,b,c){var d,e,f;if(b.terms={field:a.field},!a.settings)return b;if(b.terms.size=parseInt(a.settings.size,10),void 0!==a.settings.orderBy&&(b.terms.order={},b.terms.order[a.settings.orderBy]=a.settings.order,d=parseInt(a.settings.orderBy,10),!isNaN(d)))for(f=0;f<c.metrics.length;f++)if(e=c.metrics[f],e.id===a.settings.orderBy){b.aggs={},b.aggs[e.id]={},b.aggs[e.id][e.type]={field:e.field};break}return b},b.prototype.getInterval=function(a){return a.settings&&"auto"!==a.settings.interval?a.settings.interval:"$interval"},b.prototype.getFiltersAgg=function(a){for(var b={},c=0;c<a.settings.filters.length;c++){var d=a.settings.filters[c].query;b[d]={query:{query_string:{query:d,analyze_wildcard:!0}}}}return b},b.prototype.build=function(b){if(b.rawQuery)return a.fromJson(b.rawQuery);var c,d,e,f={size:0,query:{filtered:{query:{query_string:{analyze_wildcard:!0,query:"$lucene_query"}},filter:{bool:{must:[{range:this.getRangeFilter()}]}}}}};for(d=f,c=0;c<b.bucketAggs.length;c++){var g=b.bucketAggs[c],h={};switch(g.type){case"date_histogram":h.date_histogram={interval:this.getInterval(g),field:this.timeField,min_doc_count:1,extended_bounds:{min:"$timeFrom",max:"$timeTo"}};break;case"filters":h.filters={filters:this.getFiltersAgg(g)};break;case"terms":this.buildTermsAgg(g,h,b)}d.aggs=d.aggs||{},d.aggs[g.id]=h,d=h}for(d.aggs={},c=0;c<b.metrics.length;c++)if(e=b.metrics[c],"count"!==e.type){var i={field:e.field};for(var j in e.settings)e.settings.hasOwnProperty(j)&&null!==e.settings[j]&&(i[j]=e.settings[j]);var k={};k[e.type]=i,d.aggs[e.id]=k}return f},b.prototype.getTermsQuery=function(a){var b={size:0,query:{filtered:{query:{query_string:{analyze_wildcard:!0,query:"$lucene_query"}},filter:{bool:{must:[{range:this.getRangeFilter()}]}}}}};return b.aggs={1:{terms:{field:a.field,size:0,order:{_term:"asc"}}}},b},b});