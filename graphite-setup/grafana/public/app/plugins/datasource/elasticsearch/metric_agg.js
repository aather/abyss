/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","./query_def"],function(a,b,c){"use strict";var d=a.module("grafana.directives");d.controller("ElasticMetricAggCtrl",["$scope","uiSegmentSrv","$q","$rootScope",function(a,d,e,f){var g=a.target.metrics;a.metricAggTypes=c.metricAggTypes,a.extendedStats=c.extendedStats,a.init=function(){a.agg=g[a.index],a.validateModel()},f.onAppEvent("elastic-query-updated",function(){a.index=b.indexOf(g,a.agg),a.validateModel()},a),a.validateModel=function(){switch(a.isFirst=0===a.index,a.isSingle=1===g.length,a.settingsLinkText="",a.agg.field||(a.agg.field="select field"),a.agg.type){case"percentiles":a.agg.settings.percents=a.agg.settings.percents||[25,50,75,95,99],a.settingsLinkText="values: "+a.agg.settings.percents.join(",");break;case"extended_stats":var c=b.reduce(a.agg.meta,function(c,d,e){if(d){var f=b.findWhere(a.extendedStats,{value:e});c.push(f.text)}return c},[]);a.settingsLinkText="Stats: "+c.join(", "),0===c.length&&(a.agg.meta.std_deviation_bounds_lower=!0,a.agg.meta.std_deviation_bounds_upper=!0)}},a.toggleOptions=function(){a.showOptions=!a.showOptions},a.onTypeChange=function(){a.agg.settings={},a.agg.meta={},a.showOptions=!1,a.validateModel(),a.onChange()},a.getFieldsInternal=function(){return a.getFields({$fieldType:"number"})},a.addMetricAgg=function(){var c=g.length,d=b.reduce(a.target.bucketAggs.concat(a.target.metrics),function(a,b){return parseInt(b.id)>a?parseInt(b.id):a},0);g.splice(c,0,{type:"count",field:"select field",id:(d+1).toString()}),a.onChange()},a.removeMetricAgg=function(){g.splice(a.index,1),a.onChange()},a.init()}])});