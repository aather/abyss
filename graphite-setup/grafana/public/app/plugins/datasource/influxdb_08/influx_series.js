/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["lodash"],function(a){"use strict";function b(a){this.seriesList=a.seriesList,this.alias=a.alias,this.groupByField=a.groupByField,this.annotation=a.annotation}var c=b.prototype;return c.getTimeSeries=function(){var b,c=[],d=this;return a.each(d.seriesList,function(e){var f,g=e.columns.indexOf("time"),h=1,i=-1;d.groupByField&&(i=e.columns.indexOf(d.groupByField)),a.each(e.columns,function(a,b){"time"!==a&&"sequence_number"!==a&&a!==d.groupByField&&(h=b)});var j={};d.groupByField?j=a.groupBy(e.points,function(a){return a[i]}):j[e.columns[h]]=e.points,a.each(j,function(a,i){var j=[];for(b=0;b<a.length;b++){var k=isNaN(a[b][h])?null:a[b][h];j[b]=[k,a[b][g]]}f=e.name+"."+i,d.alias&&(f=d.createNameForSeries(e.name,i)),c.push({target:f,datapoints:j})})}),c},c.getAnnotations=function(){var b=[],c=this;return a.each(this.seriesList,function(d){var e=null,f=null,g=null,h=null;a.each(d.columns,function(a,b){if("time"===a)return void(f=b);if("sequence_number"!==a)return e||(e=b),a===c.annotation.titleColumn?void(e=b):a===c.annotation.tagsColumn?void(g=b):a===c.annotation.textColumn?void(h=b):void 0}),a.each(d.points,function(a){var d={annotation:c.annotation,time:a[f],title:a[e],tags:a[g],text:a[h]};g&&(d.tags=a[g]),b.push(d)})}),b},c.createNameForSeries=function(b,c){var d=/\$(\w+)/g,e=b.split(".");return this.alias.replace(d,function(d,f){if("s"===f)return b;if("g"===f)return c;var g=parseInt(f);return a.isNumber(g)&&g<e.length?e[g]:d})},b});