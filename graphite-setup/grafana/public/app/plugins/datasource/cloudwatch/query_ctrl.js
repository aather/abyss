/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash"],function(a,b){"use strict";var c=a.module("grafana.controllers");c.controller("CloudWatchQueryCtrl",["$scope","templateSrv","uiSegmentSrv","$q",function(c,d,e,f){c.init=function(){var a=c.target;a.namespace=a.namespace||"",a.metricName=a.metricName||"",a.statistics=a.statistics||["Average"],a.dimensions=a.dimensions||{},a.period=a.period||60,a.region=a.region||c.datasource.getDefaultRegion(),c.aliasSyntax="{{metric}} {{stat}} {{namespace}} {{region}} {{<dimension name>}}",c.regionSegment=e.getSegmentForValue(c.target.region,"select region"),c.namespaceSegment=e.getSegmentForValue(c.target.namespace,"select namespace"),c.metricSegment=e.getSegmentForValue(c.target.metricName,"select metric"),c.dimSegments=b.reduce(c.target.dimensions,function(a,b,c){return a.push(e.newKey(c)),a.push(e.newOperator("=")),a.push(e.newKeyValue(b)),a},[]),c.statSegments=b.map(c.target.statistics,function(a){return e.getSegmentForValue(a)}),c.ensurePlusButton(c.statSegments),c.ensurePlusButton(c.dimSegments),c.removeDimSegment=e.newSegment({fake:!0,value:"-- remove dimension --"}),c.removeStatSegment=e.newSegment({fake:!0,value:"-- remove stat --"})},c.getStatSegments=function(){return f.when([a.copy(c.removeStatSegment),e.getSegmentForValue("Average"),e.getSegmentForValue("Maximum"),e.getSegmentForValue("Minimum"),e.getSegmentForValue("Sum"),e.getSegmentForValue("SampleCount")])},c.statSegmentChanged=function(a,d){a.value===c.removeStatSegment.value?c.statSegments.splice(d,1):a.type="value",c.target.statistics=b.reduce(c.statSegments,function(a,b){return b.fake||a.push(b.value),a},[]),c.ensurePlusButton(c.statSegments),c.get_data()},c.ensurePlusButton=function(a){var b=a.length,c=a[Math.max(b-1,0)];c&&"plus-button"===c.type||a.push(e.newPlusButton())},c.getDimSegments=function(b){if("operator"===b.type)return f.when([]);var d=c.target,e=f.when([]);return"key"===b.type||"plus-button"===b.type?e=c.datasource.getDimensionKeys(c.target.namespace):"value"===b.type&&(e=c.datasource.getDimensionValues(d.region,d.namespace,d.metricName,{})),e.then(c.transformToSegments(!0)).then(function(d){return"key"===b.type&&d.splice(0,0,a.copy(c.removeDimSegment)),d})},c.dimSegmentChanged=function(a,b){c.dimSegments[b]=a,a.value===c.removeDimSegment.value?c.dimSegments.splice(b,3):"plus-button"===a.type&&(c.dimSegments.push(e.newOperator("=")),c.dimSegments.push(e.newFake("select dimension value","value","query-segment-value")),a.type="key",a.cssClass="query-segment-key"),c.syncDimSegmentsWithModel(),c.ensurePlusButton(c.dimSegments),c.get_data()},c.syncDimSegmentsWithModel=function(){for(var a={},b=c.dimSegments.length,d=0;b-2>d;d+=3){var e=c.dimSegments[d],f=c.dimSegments[d+2];f.fake||(a[e.value]=f.value)}c.target.dimensions=a},c.getRegions=function(){return c.datasource.metricFindQuery("regions()").then(c.transformToSegments(!0))},c.getNamespaces=function(){return c.datasource.metricFindQuery("namespaces()").then(c.transformToSegments(!0))},c.getMetrics=function(){return c.datasource.metricFindQuery("metrics("+c.target.namespace+")").then(c.transformToSegments(!0))},c.regionChanged=function(){c.target.region=c.regionSegment.value,c.get_data()},c.namespaceChanged=function(){c.target.namespace=c.namespaceSegment.value,c.get_data()},c.metricChanged=function(){c.target.metricName=c.metricSegment.value,c.get_data()},c.transformToSegments=function(a){return function(c){var f=b.map(c,function(a){return e.newSegment({value:a.text,expandable:a.expandable})});return a&&b.each(d.variables,function(a){f.unshift(e.newSegment({type:"template",value:"$"+a.name,expandable:!0}))}),f}},c.refreshMetricData=function(){b.isEqual(c.oldTarget,c.target)||(c.oldTarget=a.copy(c.target),c.get_data())},c.init()}])});