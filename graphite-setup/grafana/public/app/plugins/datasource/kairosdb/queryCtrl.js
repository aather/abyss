/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash"],function(a,b){"use strict";var c=a.module("grafana.controllers");c.controller("KairosDBQueryCtrl",["$scope",function(c){function d(a){return parseInt(a)%1===0}function e(a){var b={};a.metric||(b.metric="You must supply a metric name.");try{a.sampling&&c.datasource.convertToKairosInterval(a.sampling)}catch(d){b.sampling=d.message}return b}c.init=function(){c.panel.stack=!1,c.panel.downsampling||(c.panel.downsampling="avg"),c.target.downsampling||(c.target.downsampling=c.panel.downsampling,c.target.sampling=c.panel.sampling),c.target.errors=e(c.target)},c.targetBlur=function(){c.target.errors=e(c.target),!b.isEqual(c.oldTarget,c.target)&&b.isEmpty(c.target.errors)&&(c.oldTarget=a.copy(c.target),c.get_data())},c.panelBlur=function(){b.each(c.panel.targets,function(a){a.downsampling=c.panel.downsampling,a.sampling=c.panel.sampling}),c.get_data()},c.getTextValues=function(a){return b.map(a,function(a){return a.text})},c.suggestMetrics=function(a,b){c.datasource.metricFindQuery("metrics("+a+")").then(c.getTextValues).then(b)},c.suggestTagKeys=function(a,b){c.datasource.metricFindQuery("tag_names("+c.target.metric+")").then(c.getTextValues).then(b)},c.suggestTagValues=function(a,b){c.datasource.metricFindQuery("tag_values("+c.target.metric+","+c.target.currentTagKey+")").then(c.getTextValues).then(b)},c.addFilterTag=function(){return c.addFilterTagMode?(c.target.tags||(c.target.tags={}),c.validateFilterTag(),c.target.errors.tags||(b.has(c.target.tags,c.target.currentTagKey)||(c.target.tags[c.target.currentTagKey]=[]),c.target.tags[c.target.currentTagKey].push(c.target.currentTagValue),c.target.currentTagKey="",c.target.currentTagValue="",c.targetBlur()),void(c.addFilterTagMode=!1)):(c.addFilterTagMode=!0,void c.validateFilterTag())},c.removeFilterTag=function(a){delete c.target.tags[a],0===b.size(c.target.tags)&&(c.target.tags=null),c.targetBlur()},c.validateFilterTag=function(){c.target.errors.tags=null,c.target.currentTagKey&&c.target.currentTagValue||(c.target.errors.tags="You must specify a tag name and value.")},c.addGroupBy=function(){if(!c.addGroupByMode)return c.addGroupByMode=!0,c.target.currentGroupByType="tag",c.isTagGroupBy=!0,void c.validateGroupBy();if(c.validateGroupBy(),b.isEmpty(c.target.errors.groupBy)){if(c.isTagGroupBy)c.target.groupByTags||(c.target.groupByTags=[]),b.contains(c.target.groupByTags,c.target.groupBy.tagKey)||(c.target.groupByTags.push(c.target.groupBy.tagKey),c.targetBlur()),c.target.groupBy.tagKey="";else{c.target.nonTagGroupBys||(c.target.nonTagGroupBys=[]);var a={name:c.target.currentGroupByType};c.isValueGroupBy?a.range_size=c.target.groupBy.valueRange:c.isTimeGroupBy&&(a.range_size=c.target.groupBy.timeInterval,a.group_count=c.target.groupBy.groupCount),c.target.nonTagGroupBys.push(a)}c.targetBlur()}c.isTagGroupBy=!1,c.isValueGroupBy=!1,c.isTimeGroupBy=!1,c.addGroupByMode=!1},c.removeGroupByTag=function(a){c.target.groupByTags.splice(a,1),0===b.size(c.target.groupByTags)&&(c.target.groupByTags=null),c.targetBlur()},c.removeNonTagGroupBy=function(a){c.target.nonTagGroupBys.splice(a,1),0===b.size(c.target.nonTagGroupBys)&&(c.target.nonTagGroupBys=null),c.targetBlur()},c.changeGroupByInput=function(){c.isTagGroupBy="tag"===c.target.currentGroupByType,c.isValueGroupBy="value"===c.target.currentGroupByType,c.isTimeGroupBy="time"===c.target.currentGroupByType,c.validateGroupBy()},c.validateGroupBy=function(){delete c.target.errors.groupBy;var a={};if(c.isGroupByValid=!0,c.isTagGroupBy&&(c.target.groupBy.tagKey||(c.isGroupByValid=!1,a.tagKey="You must supply a tag name")),c.isValueGroupBy&&(c.target.groupBy.valueRange&&d(c.target.groupBy.valueRange)||(a.valueRange="Range must be an integer",c.isGroupByValid=!1)),c.isTimeGroupBy){try{c.datasource.convertToKairosInterval(c.target.groupBy.timeInterval)}catch(e){a.timeInterval=e.message,c.isGroupByValid=!1}c.target.groupBy.groupCount&&d(c.target.groupBy.groupCount)||(a.groupCount="Group count must be an integer",c.isGroupByValid=!1)}b.isEmpty(a)||(c.target.errors.groupBy=a)},c.addHorizontalAggregator=function(){if(!c.addHorizontalAggregatorMode)return c.addHorizontalAggregatorMode=!0,c.target.currentHorizontalAggregatorName="avg",c.hasSamplingRate=!0,void c.validateHorizontalAggregator();if(c.validateHorizontalAggregator(),b.isEmpty(c.target.errors.horAggregator)){c.target.horizontalAggregators||(c.target.horizontalAggregators=[]);var a={name:c.target.currentHorizontalAggregatorName};c.hasSamplingRate&&(a.sampling_rate=c.target.horAggregator.samplingRate),c.hasUnit&&(a.unit=c.target.horAggregator.unit),c.hasFactor&&(a.factor=c.target.horAggregator.factor),c.hasPercentile&&(a.percentile=c.target.horAggregator.percentile),c.target.horizontalAggregators.push(a),c.targetBlur()}c.addHorizontalAggregatorMode=!1,c.hasSamplingRate=!1,c.hasUnit=!1,c.hasFactor=!1,c.hasPercentile=!1},c.removeHorizontalAggregator=function(a){c.target.horizontalAggregators.splice(a,1),0===b.size(c.target.horizontalAggregators)&&(c.target.horizontalAggregators=null),c.targetBlur()},c.changeHorAggregationInput=function(){c.hasSamplingRate=b.contains(["avg","dev","max","min","sum","least_squares","count","percentile"],c.target.currentHorizontalAggregatorName),c.hasUnit=b.contains(["sampler","rate"],c.target.currentHorizontalAggregatorName),c.hasFactor=b.contains(["div","scale"],c.target.currentHorizontalAggregatorName),c.hasPercentile="percentile"===c.target.currentHorizontalAggregatorName,c.validateHorizontalAggregator()},c.validateHorizontalAggregator=function(){delete c.target.errors.horAggregator;var a={};if(c.isAggregatorValid=!0,c.hasSamplingRate)try{c.datasource.convertToKairosInterval(c.target.horAggregator.samplingRate)}catch(d){a.samplingRate=d.message,c.isAggregatorValid=!1}c.hasFactor&&(c.target.horAggregator.factor?0===parseInt(c.target.horAggregator.factor)&&"div"===c.target.currentHorizontalAggregatorName&&(a.factor="Cannot divide by 0",c.isAggregatorValid=!1):(a.factor="You must supply a numeric value for this aggregator",c.isAggregatorValid=!1)),c.hasPercentile&&(!c.target.horAggregator.percentile||c.target.horAggregator.percentile<=0||c.target.horAggregator.percentile>1)&&(a.percentile="Percentile must be between 0 and 1",c.isAggregatorValid=!1),b.isEmpty(a)||(c.target.errors.horAggregator=a)},c.alert=function(a){alert(a)}}])});