/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["lodash"],function(a){"use strict";function b(a){if(this.target=a,a.groupByTags){a.groupBy=[{type:"time",interval:"auto"}];for(var b in a.groupByTags)a.groupBy.push({type:"tag",key:a.groupByTags[b]});delete a.groupByTags}}function c(a,b){var c="",d=a.operator,e=a.value;return b>0&&(c=(a.condition||"AND")+" "),d||(d=/^\/.*\/$/.test(a.value)?"=~":"="),"=~"!==d&&"!~"!==d&&(e="'"+e+"'"),c+'"'+a.key+'" '+d+" "+e}var d=b.prototype;return d.build=function(){return this.target.rawQuery?this._modifyRawQuery():this._buildQuery()},d.buildExploreQuery=function(b,d){var e,f;if("TAG_KEYS"===b)e="SHOW TAG KEYS",f=this.target.measurement;else if("TAG_VALUES"===b)e="SHOW TAG VALUES",f=this.target.measurement;else if("MEASUREMENTS"===b)e="SHOW MEASUREMENTS";else if("FIELDS"===b)return e='SHOW FIELD KEYS FROM "'+this.target.measurement+'"';if(f&&(f.match("^/.*/")||f.match(/^merge\(.*\)/)||(f='"'+f+'"'),e+=" FROM "+f),d&&(e+=' WITH KEY = "'+d+'"'),this.target.tags&&this.target.tags.length>0){var g=a.reduce(this.target.tags,function(a,b){return b.key===d?a:(a.push(c(b,a.length)),a)},[]);g.length>0&&(e+=" WHERE "+g.join(" "))}return e},d._getGroupByTimeInterval=function(a){return"auto"===a?"$interval":a},d._buildQuery=function(){var b=this.target;if(!b.measurement)throw"Metric measurement is missing";b.fields||(b.fields=[{name:"value",func:b["function"]||"mean"}]);var d,e="SELECT ";for(d=0;d<b.fields.length;d++){var f=b.fields[d];d>0&&(e+=", "),e+=f.func+'("'+f.name+'")',f.mathExpr&&(e+=f.mathExpr),e+=f.asExpr?' AS "'+f.asExpr+'"':' AS "'+f.name+'"'}var g=b.measurement;g.match("^/.*/")||g.match(/^merge\(.*\)/)||(g='"'+g+'"'),e+=" FROM "+g+" WHERE ";var h=a.map(b.tags,function(a,b){return c(a,b)});for(e+=h.join(" "),e+=(h.length>0?" AND ":"")+"$timeFilter",e+=" GROUP BY",d=0;d<b.groupBy.length;d++){var i=b.groupBy[d];e+="time"===i.type?" time("+this._getGroupByTimeInterval(i.interval)+")":', "'+i.key+'"'}return b.fill&&(e+=" fill("+b.fill+")"),b.query=e,e},d._modifyRawQuery=function(){var a=this.target.query.replace(";","");return a},b});