/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["lodash"],function(a){"use strict";function b(a){this.series=a.series,this.alias=a.alias,this.annotation=a.annotation}var c=b.prototype;return c.getTimeSeries=function(){var b,c,d=[],e=this;return 0===e.series.length?d:(a.each(e.series,function(f){var g=f.columns.length,h=a.map(f.tags,function(a,b){return b+": "+a});for(c=1;g>c;c++){var i=f.name,j=f.columns[c];"value"!==j&&(i=i+"."+j),e.alias?i=e._getSeriesName(f,c):f.tags&&(i=i+" {"+h.join(", ")+"}");var k=[];if(f.values)for(b=0;b<f.values.length;b++)k[b]=[f.values[b][c],f.values[b][0]];d.push({target:i,datapoints:k})}}),d)},c._getSeriesName=function(a,b){var c=/\$(\w+)|\[\[([\s\S]+?)\]\]/g,d=a.name.split(".");return this.alias.replace(c,function(c,e,f){var g=e||f,h=parseInt(g,10);if("m"===g||"measurement"===g)return a.name;if("col"===g)return a.columns[b];if(!isNaN(h))return d[h];if(0!==g.indexOf("tag_"))return c;var i=g.replace("tag_","");return a.tags?a.tags[i]:c})},c.getAnnotations=function(){var b=[],c=this;return a.each(this.series,function(d){var e=null,f=null,g=null,h=null;a.each(d.columns,function(a,b){if("time"===a)return void(f=b);if("sequence_number"!==a)return e||(e=b),a===c.annotation.titleColumn?void(e=b):a===c.annotation.tagsColumn?void(g=b):a===c.annotation.textColumn?void(h=b):void 0}),a.each(d.values,function(a){var d={annotation:c.annotation,time:+new Date(a[f]),title:a[e],tags:a[g],text:a[h]};b.push(d)})}),b},b});