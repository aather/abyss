/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","./query_builder"],function(a,b,c){"use strict";var d=a.module("grafana.controllers");d.controller("InfluxQueryCtrl",["$scope","$timeout","$sce","templateSrv","$q","uiSegmentSrv",function(d,e,f,g,h,i){d.init=function(){if(d.target){var a=d.target;a.tags=a.tags||[],a.groupBy=a.groupBy||[{type:"time",interval:"auto"}],a.fields=a.fields||[{name:"value",func:a["function"]||"mean"}],d.queryBuilder=new c(a),d.measurementSegment=a.measurement?i.newSegment(a.measurement):i.newSelectMeasurement(),d.tagSegments=[],b.each(a.tags,function(a){a.operator||(a.operator=/^\/.*\/$/.test(a.value)?"=~":"="),a.condition&&d.tagSegments.push(i.newCondition(a.condition)),d.tagSegments.push(i.newKey(a.key)),d.tagSegments.push(i.newOperator(a.operator)),d.tagSegments.push(i.newKeyValue(a.value))}),d.fixTagSegments(),d.removeTagFilterSegment=i.newSegment({fake:!0,value:"-- remove tag filter --"})}},d.fixTagSegments=function(){var a=d.tagSegments.length,b=d.tagSegments[Math.max(a-1,0)];b&&"plus-button"===b.type||d.tagSegments.push(i.newPlusButton())},d.addGroupBy=function(){d.target.groupBy.push({type:"tag",key:"select tag"})},d.removeGroupBy=function(a){d.target.groupBy.splice(a,1),d.get_data()},d.addSelect=function(){d.target.fields.push({name:"select field",func:"mean"})},d.removeSelect=function(a){d.target.fields.splice(a,1),d.get_data()},d.changeFunction=function(a){d.target["function"]=a,d.$parent.get_data()},d.measurementChanged=function(){d.target.measurement=d.measurementSegment.value,d.$parent.get_data()},d.getFields=function(){var a=d.queryBuilder.buildExploreQuery("FIELDS");return d.datasource.metricFindQuery(a).then(d.transformToSegments(!1),d.handleQueryError)},d.toggleQueryMode=function(){d.target.rawQuery=!d.target.rawQuery},d.getMeasurements=function(){var a=d.queryBuilder.buildExploreQuery("MEASUREMENTS");return d.datasource.metricFindQuery(a).then(d.transformToSegments(!0),d.handleQueryError)},d.getFunctions=function(){var a=["count","mean","sum","min","max","mode","distinct","median","stddev","first","last"];return h.when(b.map(a,function(a){return i.newSegment(a)}))},d.getGroupByTimeIntervals=function(){var a=["auto","1s","10s","1m","2m","5m","10m","30m","1h","1d"];return h.when(b.map(a,function(a){return i.newSegment(a)}))},d.handleQueryError=function(a){return d.parserError=a.message||"Failed to issue metric query",[]},d.transformToSegments=function(a){return function(c){var d=b.map(c,function(a){return i.newSegment({value:a.text,expandable:a.expandable})});return a&&b.each(g.variables,function(a){d.unshift(i.newSegment({type:"template",value:"/$"+a.name+"$/",expandable:!0}))}),d}},d.getTagsOrValues=function(b,c){if("condition"===b.type)return h.when([i.newSegment("AND"),i.newSegment("OR")]);if("operator"===b.type){var e=d.tagSegments[c+1].value;return h.when(/^\/.*\/$/.test(e)?i.newOperators(["=~","!~"]):i.newOperators(["=","<>","<",">"]))}var f,g;return"key"===b.type||"plus-button"===b.type?(f=d.queryBuilder.buildExploreQuery("TAG_KEYS"),g=!1):"value"===b.type&&(f=d.queryBuilder.buildExploreQuery("TAG_VALUES",d.tagSegments[c-2].value),g=!0),d.datasource.metricFindQuery(f).then(d.transformToSegments(g)).then(function(c){return"key"===b.type&&c.splice(0,0,a.copy(d.removeTagFilterSegment)),c}).then(null,d.handleQueryError)},d.getFieldSegments=function(){var a=d.queryBuilder.buildExploreQuery("FIELDS");return d.datasource.metricFindQuery(a).then(d.transformToSegments(!1)).then(null,d.handleQueryError)},d.addField=function(){d.target.fields.push({name:d.addFieldSegment.value,func:"mean"}),b.extend(d.addFieldSegment,i.newPlusButton())},d.fieldChanged=function(a){"-- remove from select --"===a.name&&(d.target.fields=b.without(d.target.fields,a)),d.get_data()},d.getTagOptions=function(){var a=d.queryBuilder.buildExploreQuery("TAG_KEYS");return d.datasource.metricFindQuery(a).then(d.transformToSegments(!1)).then(null,d.handleQueryError)},d.setFill=function(a){d.target.fill=a,d.get_data()},d.tagSegmentUpdated=function(a,b){d.tagSegments[b]=a,a.value===d.removeTagFilterSegment.value?(d.tagSegments.splice(b,3),0===d.tagSegments.length?d.tagSegments.push(i.newPlusButton()):d.tagSegments.length>2&&(d.tagSegments.splice(Math.max(b-1,0),1),"plus-button"!==d.tagSegments[d.tagSegments.length-1].type&&d.tagSegments.push(i.newPlusButton()))):("plus-button"===a.type&&(b>2&&d.tagSegments.splice(b,0,i.newCondition("AND")),d.tagSegments.push(i.newOperator("=")),d.tagSegments.push(i.newFake("select tag value","value","query-segment-value")),a.type="key",a.cssClass="query-segment-key"),b+1===d.tagSegments.length&&d.tagSegments.push(i.newPlusButton())),d.rebuildTargetTagConditions()},d.rebuildTargetTagConditions=function(){var a=[],c=0,e="";b.each(d.tagSegments,function(b,f){"key"===b.type?(0===a.length&&a.push({}),a[c].key=b.value):"value"===b.type?(e=d.getTagValueOperator(b.value,a[c].operator),e&&(d.tagSegments[f-1]=i.newOperator(e),a[c].operator=e),a[c].value=b.value):"condition"===b.type?(a.push({condition:b.value}),c+=1):"operator"===b.type&&(a[c].operator=b.value)}),d.target.tags=a,d.$parent.get_data()},d.getTagValueOperator=function(a,b){return"=~"!==b&&"!~"!==b&&/^\/.*\/$/.test(a)?"=~":"=~"!==b&&"!~"!==b||!/^(?!\/.*\/$)/.test(a)?void 0:"="},d.init()}])});