/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","config"],function(a,b,c){"use strict";var d=a.module("grafana.controllers");d.controller("SearchCtrl",["$scope","$location","$timeout","backendSrv",function(a,d,e,f){a.init=function(){a.giveSearchFocus=0,a.selectedIndex=-1,a.results=[],a.query={query:"",tag:[],starred:!1},a.currentSearchId=0,e(function(){a.giveSearchFocus=a.giveSearchFocus+1,a.query.query="",a.search()},100)},a.keyDown=function(b){if(27===b.keyCode&&a.dismiss(),40===b.keyCode&&a.moveSelection(1),38===b.keyCode&&a.moveSelection(-1),13===b.keyCode){if(a.tagMode){var c=a.results[a.selectedIndex];return void(c&&a.filterByTag(c.term))}var e=a.results[a.selectedIndex];e&&(d.search({}),d.path(e.url))}},a.moveSelection=function(b){var c=(a.results||[]).length,d=a.selectedIndex+b;a.selectedIndex=(d%=c)<0?d+c:d},a.searchDashboards=function(){a.tagsMode=!1,a.currentSearchId=a.currentSearchId+1;var d=a.currentSearchId;return f.search(a.query).then(function(e){d<a.currentSearchId||(a.results=b.map(e,function(a){return a.url="dashboard/"+a.uri,a}),a.queryHasNoFilters()&&a.results.unshift({title:"Home",url:c.appSubUrl+"/",type:"dash-home"}))})},a.queryHasNoFilters=function(){var b=a.query;return""===b.query&&b.starred===!1&&0===b.tag.length},a.filterByTag=function(b,c){a.query.tag.push(b),a.search(),a.giveSearchFocus=a.giveSearchFocus+1,c&&(c.stopPropagation(),c.preventDefault())},a.removeTag=function(c,d){a.query.tag=b.without(a.query.tag,c),a.search(),a.giveSearchFocus=a.giveSearchFocus+1,d.stopPropagation(),d.preventDefault()},a.getTags=function(){return f.get("/api/dashboards/tags").then(function(b){a.tagsMode=!0,a.results=b,a.giveSearchFocus=a.giveSearchFocus+1})},a.showStarred=function(){a.query.starred=!a.query.starred,a.giveSearchFocus=a.giveSearchFocus+1,a.search()},a.search=function(){a.showImport=!1,a.selectedIndex=0,a.searchDashboards()},a.newDashboard=function(){d.url("dashboard/new")}}])});