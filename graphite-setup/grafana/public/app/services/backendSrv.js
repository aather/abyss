/*! grafana - v2.5.0 - 2015-10-28
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","config"],function(a,b,c){"use strict";var d=a.module("grafana.services");d.service("backendSrv",["$http","alertSrv","$timeout",function(a,d,e){var f=this;this.get=function(a,b){return this.request({method:"GET",url:a,params:b})},this["delete"]=function(a){return this.request({method:"DELETE",url:a})},this.post=function(a,b){return this.request({method:"POST",url:a,data:b})},this.patch=function(a,b){return this.request({method:"PATCH",url:a,data:b})},this.put=function(a,b){return this.request({method:"PUT",url:a,data:b})},this._handleError=function(a){return function(){if(!a.isHandled){var c=a.data||{message:"Unexpected error"};if(b.isString(c)&&(c={message:c}),422===a.status)throw d.set("Validation failed",c.message,"warning",4e3),c;throw c.severity="error",a.status<500&&(c.severity="warning"),c.message&&d.set("Problem!",c.message,c.severity,1e4),c}}},this.request=function(b){b.retry=b.retry||0;var g=0===b.url.indexOf("/"),h=0===b.retry;return g&&!b.hasSubUrl&&(b.url=c.appSubUrl+b.url,b.hasSubUrl=!0),a(b).then(function(a){return"GET"!==b.method&&a&&a.data.message&&d.set(a.data.message,"","success",3e3),a.data},function(a){if(401===a.status&&h)return f.loginPing().then(function(){return b.retry=1,f.request(b)});throw e(f._handleError(a),50),a})},this.datasourceRequest=function(b){b.retry=b.retry||0;var c=0===b.url.indexOf("/"),d=0===b.retry;return a(b).then(null,function(a){if(c&&d&&401===a.status)return f.loginPing().then(function(){return b.retry=1,f.datasourceRequest(b)});throw a})},this.loginPing=function(){return this.request({url:"/api/login/ping",method:"GET",retry:1})},this.search=function(a){return this.get("/api/search",a)},this.getDashboard=function(a,b){return this.get("/api/dashboards/"+a+"/"+b)},this.saveDashboard=function(a,b){return b=b||{},this.post("/api/dashboards/db/",{dashboard:a,overwrite:b.overwrite===!0})}}])});